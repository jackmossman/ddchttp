name: CI

on:
  push:
    branches: [ main ]
    tags: ['v*.*.*']
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint:
    name: Lint (super-linter)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint codebase
        uses: github/super-linter@v4
        env:
          VALIDATE_YAML: true
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    name: Run tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 10.0.x

      - name: Restore
        run: dotnet restore

      - name: Run tests (Release)
        run: dotnet test ./test/ddchttp.core.tests/ddchttp.core.tests.csproj -c Release --no-build || dotnet test ./test/ddchttp.core.tests/ddchttp.core.tests.csproj -c Release

  build:
    name: Build native binaries
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        rid: [linux-arm64, linux-x64]
    container:
      image: mcr.microsoft.com/dotnet/sdk:10.0
      options: --user root

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Publish native AOT binary (${{ matrix.rid }})
        env:
          RUNTIME: ${{ matrix.rid }}
        run: |
          echo "installing toolchain"
          if [ "$RUNTIME" = "linux-arm64" ]; then
            apt-get update && apt-get install -y clang llvm gcc-aarch64-linux-gnu
          else
            apt-get update && apt-get install -y clang llvm build-essential
          fi

          dotnet publish src/ddchttp.web/ddchttp.web.csproj -c Release -r $RUNTIME --self-contained true -o publish

          # Ensure files created by container (root-owned) are accessible to the runner
          chown -R $(id -u):$(id -g) publish || true

          # Move produced binary to a deterministic name
          if [ -f publish/ddchttp.web ]; then
            mv publish/ddchttp.web "ddchttp-${RUNTIME}"
          elif [ -f publish/ddchttp ]; then
            mv publish/ddchttp "ddchttp-${RUNTIME}"
          else
            echo "Build output not found for $RUNTIME"
            ls -la publish || true
            exit 1
          fi

          chmod +x "ddchttp-${RUNTIME}"
          ls -la "ddchttp-${RUNTIME}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ddchttp-${{ matrix.rid }}
          path: ddchttp-${{ matrix.rid }}

  create-release:
    name: Create Release and attach binaries
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release assets
        run: |
          mkdir -p release_assets
          find artifacts -type f -name "ddchttp-*" -exec cp {} release_assets/ \;
          ls -la release_assets

      - name: Create GitHub Release and attach binaries
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          artifacts: release_assets/*
